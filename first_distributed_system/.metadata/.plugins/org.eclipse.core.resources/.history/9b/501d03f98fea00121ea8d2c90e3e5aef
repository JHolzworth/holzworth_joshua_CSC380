package Controller;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.PrintWriter;
import java.lang.reflect.Method;
import java.net.Socket;
import java.util.ArrayList;
import java.util.Scanner;

public class ClientProcessor implements Runnable{

	MathLogic logic;
	Socket clientSocket;
	ArrayList<Connectable> listeners = new ArrayList<Connectable>();
	public ClientProcessor(MathLogic _logic, Socket _clientSocket){
		logic = _logic;
		clientSocket = _clientSocket;
	}
	
	public void addListener(Connectable toAdd){
		listeners.add(toAdd);
	}
	
	public void removeListener(Connectable toRemove){
		listeners.remove(toRemove);
	}
	
	
	public void connect(){
		for(Connectable c : listeners){
			c.connect();
		}
	}
	
	public void request(String request){
		for(Connectable c : listeners){
			c.request(request);
		}
	}
	public void response(String response){
		for(Connectable c : listeners){
			c.response(response);
		}
	}
	
	public void disconnect(){
		for(Connectable c : listeners){
			c.disconnect();
		}
	}
	

	public String obtainClientOptions(){
		Method[] logicMethods = MathLogic.class.getDeclaredMethods();
		String options = "";
		
		for(int i=0;i<logicMethods.length;i++){
			options+=logicMethods[i].getName()+" ";
		}
		return options;
	}
	
	
	public void run() {
		connect();
		try {

			OutputStream clientOutput = clientSocket.getOutputStream();
			PrintWriter clientWriter = new PrintWriter(clientOutput);
			clientWriter.write(obtainClientOptions());
			clientWriter.flush();
			clientSocket.shutdownOutput();

			InputStream clientInput = clientSocket.getInputStream();
			Scanner inputReader = new Scanner(clientInput);
			
			
			String requestedMethod = inputReader.next();
			String request = requestedMethod;
			ArrayList<Integer> numbers = new ArrayList<Integer>();
			while(inputReader.hasNext()){
				String nextNumber = inputReader.next();
				request+=" "+nextNumber;
				numbers.add(Integer.parseInt(nextNumber));
			}
			request(request);
			
			int[] realNumbers = new int[numbers.size()];
			for(int i=0;i<numbers.size();i++){
				realNumbers[i] = numbers.get(i);
			}
			
			Method method = logic.getClass().getMethod(requestedMethod, int[].class);
			int value = (int)method.invoke(logic, realNumbers);
			
			
			request(request);
			
			String response = "Value "+value;
			response(response);
			clientWriter.write(response);
			clientWriter.flush();
			clientWriter.close();
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		disconnect();
	}

}
